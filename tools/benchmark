#!/usr/bin/env node
'use strict';

var path = require('path');
var util = require('util');
var fs = require('fs');

var Benchmark = require('benchmark').Benchmark;
var sprintfjs = require('sprintf-js');

var f2 = require('../bundle');

var Suite = Benchmark.Suite;
var suite = new Suite();

var REGRESS_WATERMARK = 0.1;

var currResults = {};

function getResults() {
    try {
        return require(path.join(__dirname, 'benchmark.json'));
    } catch (err) {
        return {};
    }
}

function setResults(results) {
    fs.writeFileSync(path.join(__dirname, 'benchmark.json'), JSON.stringify(results, null, 4));
}

Benchmark.options.minSamples = 100;

var member = {
    person: {
        name: 'Polly',
        wants: 'cracker'
    }
};

0 &&
suite.add('(args) util.format', function () {
    util.format('foo %s bar %s baz', '42', '42');
    util.format('foo %s bar %s baz %s zot', '42', '42', '42');
    util.format('foo %s bar %s baz %s zot %s omg',  '42', '42', '42', '42');
});

0 &&
suite.add('(args) sprintfjs.sprintf', function () {
    sprintfjs.sprintf('foo %s bar %s baz', '42', '42');
    sprintfjs.sprintf('foo %s bar %s baz %s zot', '42', '42', '42');
    sprintfjs.sprintf('foo %s bar %s baz %s zot %s omg',  '42', '42', '42', '42');
});

0 &&
suite.add('(args) f2.subst', function () {
    f2.subst('foo %s bar %s baz', '42', '42');
    f2.subst('foo %s bar %s baz %s zot', '42', '42', '42');
    f2.subst('foo %s bar %s baz %s zot %s omg',  '42', '42', '42', '42');
});

0 &&
suite.add('(kwargs) sprintfjs.sprintf', function () {
    sprintfjs.sprintf('%(name)s wants %(wants)s', member.person);
    sprintfjs.sprintf('%(person.name)s wants %(person.wants)s', member);
    sprintfjs.sprintf('%(member.person.name)s wants %(member.person.wants)s', {member: member});
});

0 &&
suite.add('(kwargs) f2.subst', function () {
    f2.subst('%(name)s wants %(wants)s', member.person);
    f2.subst('%(person.name)s wants %(person.wants)s', member);
    f2.subst('%(member.person.name)s wants %(member.person.wants)s', {member: member});
});

0 &&
suite.add('(args swapping) sprintfjs.sprintf', function () {
    sprintfjs.sprintf('%1$s', '1');
    sprintfjs.sprintf('%2$s %1$s', '1', '2');
    sprintfjs.sprintf('%3$s %2$s %1$s', '1', '2', '3');
});

0 &&
suite.add('(args swapping) f2.subst', function () {
    f2.subst('%1$s', '1');
    f2.subst('%2$s %1$s', '1', '2');
    f2.subst('%3$s %2$s %1$s', '1', '2', '3');
});

var o = {x: 42, y: {z: 12, foo: {bar: 11}}};

suite.add('!avg', function () {
    f2.subst('%s %(x)s %(y.z)s %(y.foo.bar)s %2$s %1$s %s', '1', '2', '3', '4', o);
});

suite.on('cycle', function (event) {
    const {name, hz, stats: {rme}} = event.target;

    if (/^\s*!/.test(name)) {
        currResults[name] = hz + (hz / 100) * rme;
    }

    console.log(String(event.target));
});

suite.on('complete', function () {
    var prevResults = getResults();

    Object.keys(currResults).forEach(function (name) {
        var regressSize = (prevResults[name] / currResults[name]) - 1;
        if (prevResults.hasOwnProperty(name) && regressSize > REGRESS_WATERMARK) {
            throw new Error(f2.subst('Regression in "%s": %d%!', name, Math.round(regressSize * 10000) / 100));
        }
    });

    setResults(currResults);

    console.log();
});

suite.run({
    queued: true,
    async: true
});

process.on('uncaughtException', function (err) {
    process.stderr.write(err.stack);
    process.exit(1);
});
